<?php

/**
 * Implements hook_block_info()
 */
function ob_wall_block_info() {
  $blocks = array(
    'ob_create_post' => array(
      'info' => t('Wall'),
    ),
  );
  return $blocks;
}

/**
 * Implements hook_block_view()
 */
function ob_wall_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'ob_create_post':
      $block['content'] = drupal_get_form('og_wall_form');
    break;
  }
  return $block;
}

function og_wall_form($form, &$form_state){
  $form['image'] = array(
    '#title' => t('Imagen'),
    '#type' => 'managed_file',
    '#upload_location' => 'public://wall/',
     '#upload_validators' => array('file_validate_extensions' => array('png gif jpg jpeg')),
  );

  $form['text'] = array(
    '#title' => t('Publicación'),
    '#type' => 'textarea',
  );

  $form['archivo'] = array(
    '#title' => t('Archivo'),
    '#type' => 'managed_file',
    '#upload_location' => 'public://wall/',
     '#upload_validators' => array('file_validate_extensions' => array('pdf doc docx')),
  );

  $options = ob_wall_get_dept('departamento');
  
  $form['permissions'] = array(
    '#type' => 'select',
       '#title' => '',
       '#options' => $options,
  );

  $form['enviar'] =  array(
    '#type' => 'submit',
    '#value' => t('Publicate')
  );

  return $form;
}


function og_wall_form_submit($form, &$form_state){
  $counter = variable_get('ob_wall_counter', 1);
  $counter ++;
 global $user;
  $node = new stdClass();
  $node->type = 'ob_wall';
  $node->title = 'public_' . $counter;
  $node->language = LANGUAGE_NONE;
  $node->uid = $user->uid;
  $node->name = $user->name;
  node_object_prepare($node);
  
  if($form_state['values']['image'] != 0){
    $file = $form['image']['#file'];
    $file->status = 1;
    file_save($file);
    $node->field_imagen['und'][0] = (array) $file;
  }
  

  $node->body['und'][0]['value'] = trim($form['text']['#value']);
  $node->format = 'plain_text';

  if($form_state['values']['archivo'] != 0){
    $archivo = $form['archivo']['#file'];
    $archivo->status = 1;
    $archivo->display = 1;
    file_save($archivo);
    $node->field_archivo['und'][0] = (array) $archivo;
  }

  $permissions = array();
  if ($form_state['values']['permissions'] == 'friend_group') {
  } else {
    $permissions[] = $form_state['values']['permissions'];
  }

  foreach ($permissions as $key => $value) {
    $node->field_permissions['und'][$key]['value'] = $value;
  }
  # code...
  node_save($node);
  variable_set('ob_wall_counter', $counter);
  drupal_set_message(t('Se ha generado la publicación'));
}

function ob_wall_get_dept($machine_name){
  $v = taxonomy_vocabulary_machine_name_load($machine_name);
  $terms = taxonomy_get_tree($v->vid);
  
  $options = array(
    'public' => t('Publico'),
    'friend_group' => t('Grupo de amigos'),
    'specific' => t('Personal'),
  );
  foreach ($terms as $term => $value) {
    $options['term_' . $value->tid] = $value->name;
  }
  return ($options);
}




function ob_wall_tiempo_transcurrido($fecha) {
  if(empty ($fecha)) {
    return "No hay fecha";
  }
 
  $intervalos = array (t("segundo"), t("minuto"), t("hora"), t("dí­a"), t("semana"), t("mes"), t("año"));
  $duraciones = array ("60","60","24","7","4.35","12");
 
  $ahora = time ();
  $Fecha_Unix = $fecha;
 
  if(empty ($Fecha_Unix)) {  
    return t("Fecha incorrecta");
  }

  if($ahora > $Fecha_Unix) {  
    $diferencia     = $ahora - $Fecha_Unix;
    $tiempo         = t("Hace");
  } else {
    $diferencia     = $Fecha_Unix - $ahora;
    $tiempo         = t("Dentro de");
  }
  for($j = 0; $diferencia >= $duraciones[$j] && $j < count ($duraciones)-1; $j++) {
    $diferencia /= $duraciones[$j];
  }
 
  $diferencia = round ($diferencia);
 
  if($diferencia != 1) {
    $intervalos[5].="e"; //meses... la magia del español
    $intervalos[$j].= "s";
  }
 
  return "$tiempo $diferencia $intervalos[$j]";
}